name: Weekly Price Snapshot

on:
  schedule:
    # Run every Sunday at 00:00 UTC
    - cron: '0 0 * * 0'
  workflow_dispatch: # Allow manual trigger

jobs:
  snapshot:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Take price snapshot
        run: |
          node << 'EOF'
          const fs = require('fs');

          // Load current pricing data
          const pricingData = JSON.parse(fs.readFileSync('public/data/llm-pricing.json', 'utf8'));
          const historyData = JSON.parse(fs.readFileSync('public/data/price-history.json', 'utf8'));

          const today = new Date().toISOString().split('T')[0];

          // Check if we already have a snapshot for today
          const existingSnapshot = historyData.snapshots.find(s => s.date === today);
          if (existingSnapshot) {
            console.log(`Snapshot for ${today} already exists. Skipping.`);
            process.exit(0);
          }

          // Create new snapshot from current pricing
          const newSnapshot = {
            date: today,
            models: pricingData.models.map(m => ({
              id: m.id,
              name: m.name,
              provider: m.provider,
              input_1m: m.pricing.input_1m,
              output_1m: m.pricing.output_1m,
              cached_1m: m.pricing.cached_input_1m || null
            }))
          };

          // Detect price changes from last snapshot
          const lastSnapshot = historyData.snapshots[historyData.snapshots.length - 1];
          const priceChanges = [];
          const significantDrops = []; // Drops >= 5% for alert notifications

          if (lastSnapshot) {
            for (const model of newSnapshot.models) {
              const oldModel = lastSnapshot.models.find(m => m.id === model.id);
              if (oldModel) {
                // Check input price change
                if (oldModel.input_1m !== model.input_1m) {
                  const changePercent = ((model.input_1m - oldModel.input_1m) / oldModel.input_1m * 100);
                  priceChanges.push({
                    date: today,
                    model_id: model.id,
                    provider: model.provider,
                    field: 'input_1m',
                    old_value: oldModel.input_1m,
                    new_value: model.input_1m,
                    change_percent: parseFloat(changePercent.toFixed(1))
                  });
                  console.log(`ðŸ“Š ${model.id} input: $${oldModel.input_1m} â†’ $${model.input_1m} (${changePercent.toFixed(1)}%)`);

                  // Track significant drops (>= 5% decrease)
                  if (changePercent <= -5) {
                    significantDrops.push({
                      modelId: model.id,
                      modelName: model.name || model.id,
                      provider: model.provider,
                      oldPrice: oldModel.input_1m,
                      newPrice: model.input_1m,
                      changePercent: parseFloat(changePercent.toFixed(1)),
                      field: 'input_1m'
                    });
                  }
                }
                // Check output price change
                if (oldModel.output_1m !== model.output_1m) {
                  const changePercent = ((model.output_1m - oldModel.output_1m) / oldModel.output_1m * 100);
                  priceChanges.push({
                    date: today,
                    model_id: model.id,
                    provider: model.provider,
                    field: 'output_1m',
                    old_value: oldModel.output_1m,
                    new_value: model.output_1m,
                    change_percent: parseFloat(changePercent.toFixed(1))
                  });
                  console.log(`ðŸ“Š ${model.id} output: $${oldModel.output_1m} â†’ $${model.output_1m} (${changePercent.toFixed(1)}%)`);

                  // Track significant drops (>= 5% decrease)
                  if (changePercent <= -5) {
                    significantDrops.push({
                      modelId: model.id,
                      modelName: model.name || model.id,
                      provider: model.provider,
                      oldPrice: oldModel.output_1m,
                      newPrice: model.output_1m,
                      changePercent: parseFloat(changePercent.toFixed(1)),
                      field: 'output_1m'
                    });
                  }
                }
              } else {
                console.log(`ðŸ†• New model detected: ${model.id}`);
              }
            }
          }

          // Add snapshot and price changes
          historyData.snapshots.push(newSnapshot);
          historyData.price_changes.push(...priceChanges);
          historyData.metadata.last_snapshot = today;

          // Write updated history
          fs.writeFileSync(
            'public/data/price-history.json',
            JSON.stringify(historyData, null, 2)
          );

          console.log(`âœ… Snapshot added for ${today}`);
          console.log(`ðŸ“ˆ Total snapshots: ${historyData.snapshots.length}`);
          console.log(`ðŸ“‹ Price changes detected: ${priceChanges.length}`);
          console.log(`ðŸ”” Significant drops (>= 5%): ${significantDrops.length}`);

          // Set output for commit message
          fs.writeFileSync('snapshot_summary.txt',
            `Added price snapshot for ${today}. Models: ${newSnapshot.models.length}. Changes: ${priceChanges.length}. Drops: ${significantDrops.length}`
          );

          // Write drops for alert notification step
          fs.writeFileSync('price_drops.json', JSON.stringify(significantDrops));
          EOF

      - name: Check for changes
        id: check_changes
        run: |
          if git diff --quiet public/data/price-history.json; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

          # Check if there are significant drops
          DROPS=$(cat price_drops.json 2>/dev/null || echo "[]")
          if [ "$DROPS" = "[]" ]; then
            echo "has_drops=false" >> $GITHUB_OUTPUT
          else
            echo "has_drops=true" >> $GITHUB_OUTPUT
          fi

      - name: Commit and push snapshot
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          SUMMARY=$(cat snapshot_summary.txt 2>/dev/null || echo "Weekly price snapshot")

          git add public/data/price-history.json
          git commit -m "chore(data): $SUMMARY"
          git push

      - name: Notify price alert subscribers
        if: steps.check_changes.outputs.has_drops == 'true'
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          DROPS=$(cat price_drops.json)
          echo "ðŸ“§ Sending price drop alerts for: $DROPS"

          RESPONSE=$(curl -s -w "\n%{http_code}" \
            -X POST "${SUPABASE_URL}/functions/v1/check-price-shifts" \
            -H "Authorization: Bearer ${SUPABASE_SERVICE_ROLE_KEY}" \
            -H "Content-Type: application/json" \
            -d "{\"drops\": $DROPS}")

          HTTP_CODE=$(echo "$RESPONSE" | tail -1)
          BODY=$(echo "$RESPONSE" | head -n -1)

          echo "Response ($HTTP_CODE): $BODY"

          if [ "$HTTP_CODE" -ne 200 ]; then
            echo "âš ï¸ Alert notification failed with status $HTTP_CODE"
          else
            echo "âœ… Alert notifications sent successfully"
          fi

      - name: Summary
        run: |
          echo "## Price Snapshot Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f snapshot_summary.txt ]; then
            cat snapshot_summary.txt >> $GITHUB_STEP_SUMMARY
          else
            echo "No changes detected" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f price_drops.json ]; then
            DROPS=$(cat price_drops.json)
            if [ "$DROPS" != "[]" ]; then
              echo "### Price Drops (>= 5%)" >> $GITHUB_STEP_SUMMARY
              echo '```json' >> $GITHUB_STEP_SUMMARY
              echo "$DROPS" | python3 -m json.tool >> $GITHUB_STEP_SUMMARY 2>/dev/null || echo "$DROPS" >> $GITHUB_STEP_SUMMARY
              echo '```' >> $GITHUB_STEP_SUMMARY
            fi
          fi
